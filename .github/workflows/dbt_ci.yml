name: dbt_slim_ci

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  dbt_run_ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dbt_snowflake_pipeline
      # Define these at the JOB level so all steps (and macros) can see them
    env:
      DBT_ENV: CI
      SNOWFLAKE_DEV_DATABASE: "DEVELOPMENT_GLOBAL"
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: "DEVELOPMENT_GLOBAL"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- NEW SANITIZATION STEP --- 2026-01-21
      - name: Sanitize Branch Name for Snowflake
        run: |
          # Replace hyphens with underscores and save to GITHUB_ENV
          CLEAN_SCHEMA=$(echo "CI_${{ github.head_ref }}" | sed 's/-/_/g')
          echo "SNOWFLAKE_SCHEMA=$CLEAN_SCHEMA" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Dependencies
        run: |
          pip install dbt-snowflake
          dbt deps

      - name: Download Production Manifest from S3
        run: |
          mkdir -p prod_artifacts
          # Ensure this secret name matches exactly what you have in GitHub settings
          aws s3 cp s3://${{ secrets.DBT_PROD_MANIFEST_AWS_S3_BUCKET_NAME }}/dbt_artifacts/manifest.json prod_artifacts/manifest.json
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: dbt Build (Slim CI)
        run: |
          # 2026-01-20 -> Added --target to be explicit and ensure we build against the dev profile
          # 2026-01-21 -> Added --profiles-dir . to tell dbt the profile is in the current folder
          dbt build --full-refresh --select state:modified+ --state prod_artifacts --target dev --profiles-dir .
